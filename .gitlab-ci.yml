variables:
  CARGO_HOME: $CI_PROJECT_DIR/cargo
  RUST_BACKTRACE: 1

before_script:
  - rustup component add rustfmt-preview

stages:
  - pedantry
  - clippy
  - test
  - bench

rustfmt:
  stage: pedantry
  image: "rustlang/rust:nightly"
  script:
    # there should be no println in src
    - '[[ `grep -E -r -e "(\s+|^)println" src/*` == "" ]]'
    - rustup component add rustfmt
    - cargo fmt -- --check

cargo-deny:
  stage: pedantry
  image: "rust:1"
  script:
    - cargo install --locked cargo-deny
    - cargo deny check

clippy:
  stage: pedantry
  image: "rust:1"
  script:
    - rustup component add clippy
    - sed -i 's/\!\[warn/\!\[deny/' src/lib.rs  # deny lints
    - cargo clippy --all-features

test:features:
  stage: test
  image: rust:1
  script:
    - cargo install cargo-hack --locked
    - cargo hack --each-feature check
    - cargo hack --each-feature test

# just make sure that the benched didn't get broken
bench:cargo-stable:
  stage: bench
  only:
    - master
  image: "rust:1"
  script:
    - cargo bench --no-run --features arraydist
